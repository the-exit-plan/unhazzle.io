<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infrastructure Canvas - unhazzle</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="mockup-styles.css">
    <style>
        .resource-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .resource-modal.active {
            display: flex;
        }

        .resource-modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow: visible;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .resource-modal-header {
            padding: var(--space-5);
            border-bottom: none;
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            z-index: 50;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        .resource-modal-header h2 {
            margin: 0 0 var(--space-1) 0;
            font-size: var(--font-size-xl);
            color: white;
            font-weight: 600;
        }

        .resource-modal-header p {
            margin: 0;
            color: rgba(255, 255, 255, 0.9);
            font-size: var(--font-size-sm);
        }

        .resource-modal-body {
            padding: var(--space-5);
            padding-top: calc(var(--space-5) + 40px);
        }

        .resource-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
        }

        .resource-option {
            padding: var(--space-4);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-primary);
            position: relative;
        }

        .resource-option:hover {
            border-color: var(--primary-color);
            background: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .resource-option.highlighted {
            border-color: var(--primary-color);
            background: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .resource-option-icon {
            font-size: 2rem;
            margin-bottom: var(--space-2);
        }

        .resource-option h3 {
            margin: 0 0 var(--space-1) 0;
            font-size: var(--font-size-base);
            color: var(--text-primary);
            font-weight: 600;
        }

        .resource-option p {
            margin: 0;
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .modal-close {
            position: absolute;
            top: var(--space-3);
            right: var(--space-3);
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .tour-tooltip {
            position: absolute;
            bottom: calc(100% + 12px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: tooltipBounce 2s ease-in-out infinite;
            z-index: 100;
        }

        .tour-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: var(--primary-color);
        }

        @keyframes tooltipBounce {
            0%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            50% {
                transform: translateX(-50%) translateY(-4px);
            }
        }

        .editor-tooltip {
            position: absolute;
            top: 60px;
            right: var(--space-4);
            background: var(--primary-color);
            color: white;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: editorTooltipFade 8s ease-in-out forwards;
            z-index: 10;
            max-width: 280px;
        }

        .editor-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 20px;
            border: 6px solid transparent;
            border-bottom-color: var(--primary-color);
        }

        @keyframes editorTooltipFade {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }
            10% {
                opacity: 1;
                transform: translateY(0);
            }
            85% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .code-editor-container {
            position: relative;
        }

        .apply-button-tooltip {
            position: absolute;
            bottom: calc(100% + 12px);
            right: 0;
            background: var(--primary-color);
            color: white;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .apply-button-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 20px;
            border: 8px solid transparent;
            border-top-color: var(--primary-color);
        }

        @keyframes applyTooltipBounce {
            0%, 100% {
                bottom: calc(100% + 12px);
            }
            50% {
                bottom: calc(100% + 16px);
            }
        }

        .apply-button-tooltip {
            animation: applyTooltipBounce 2s ease-in-out infinite;
        }

        #apply-button {
            position: relative;
        }

        .add-resource-tooltip {
            position: absolute;
            bottom: calc(100% + 12px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: tooltipBounce 2s ease-in-out infinite;
            z-index: 100;
            pointer-events: none;
        }

        .add-resource-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: var(--primary-color);
        }

        .canvas-workspace {
            background-image: 
                radial-gradient(circle, var(--border-color) 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0;
            position: relative;
            overflow: visible;
        }

        .resource-node {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: visible;
        }

        .resource-node:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }

        .resource-node.expanded {
            border-color: var(--accent-color);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            background: var(--bg-secondary);
        }

        .resource-node-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .resource-node-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            padding: var(--space-2);
            border-radius: var(--radius-md);
            transition: background 0.2s ease;
        }

        .resource-node-title:focus {
            outline: none;
            background: var(--bg-secondary);
        }

        .resource-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: 4px var(--space-2);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .resource-badge::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 4px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        .resource-node-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .resource-info-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .resource-info-label {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 80px;
        }

        .resource-info-value {
            color: var(--text-secondary);
        }

        .resource-config-trigger {
            margin-top: var(--space-3);
            padding: var(--space-3);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 500;
            color: var(--primary-color);
        }

        .resource-config-trigger:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
        }

        .resource-config-content {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease, margin-top 0.3s ease, padding-top 0.3s ease;
        }

        .resource-config-content > div {
            overflow: hidden;
        }

        .resource-node.expanded .resource-config-content {
            grid-template-rows: 1fr;
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--border-color);
        }
        
        .resource-node.expanded .resource-config-content > div {
            overflow: visible;
        }

        .resource-node.expanded .resource-config-trigger {
            display: none;
        }

        .config-close-btn {
            margin-top: var(--space-4);
            width: 100%;
            padding: var(--space-3);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .config-close-btn:hover {
            background: var(--bg-primary);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .config-field {
            margin-bottom: var(--space-4);
        }

        .config-field label {
            display: block;
            font-weight: 600;
            margin-bottom: var(--space-2);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }

        .config-field input,
        .config-field select,
        .config-field textarea {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            background: var(--bg-primary);
            transition: border-color 0.2s ease;
        }

        .config-field input:focus,
        .config-field select:focus,
        .config-field textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .config-field small {
            display: block;
            margin-top: var(--space-1);
            color: var(--text-tertiary);
            font-size: var(--font-size-xs);
        }

        .config-field-checkbox {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            cursor: pointer;
        }

        .config-field-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-container">
            <div class="logo">
                <a href="../index.html" class="logo-text">unhazzle</a>
                <span class="project-info">Project: silent-wind-1234 (dev)</span>
            </div>
            <nav class="header-nav">
                <div class="user-info">
                    <div id="userAvatar" class="avatar">T</div>
                    <span id="userNameDisplay" style="color: var(--text-primary); font-weight: 500;">Tavo</span>
                </div>
                <a href="docs.html" class="header-link">📖 Docs</a>
                <a href="02-dashboard.html" class="header-link">← Dashboard</a>
                <a href="01-signin.html" class="header-link">Logout</a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div style="margin-bottom: var(--space-6);">
            <h1 style="font-size: var(--font-size-3xl); margin-bottom: var(--space-2);">
                Infrastructure Canvas
            </h1>
            <p style="color: var(--text-secondary); font-size: var(--font-size-lg);">
                Design your infrastructure visually. Changes sync automatically with the YAML manifest—your single source of truth for provisioned infrastructure and CI/CD workflows.
            </p>
        </div>

        <div class="canvas-container">
            <div class="canvas-workspace" style="border-style: solid; border-color: var(--primary-color);">
                <div class="resource-node" id="app-node">
                    <button class="resource-remove-btn" onclick="removeResource('application')" title="Remove resource">×</button>
                    <div class="resource-node-header">
                        <div class="resource-node-title" contenteditable="true" id="app-name-title" data-resource-type="application">my-awesome-app</div>
                        <div class="resource-badge">App</div>
                    </div>
                    <div class="resource-node-content">
                        <div class="resource-info-item">
                            <span class="resource-info-label">Repository:</span>
                            <span class="resource-info-value" style="font-family: 'Monaco', 'Menlo', monospace; font-size: var(--font-size-xs);">github.com/tavo/my-awesome-app</span>
                        </div>
                        <div class="resource-info-item">
                            <span class="resource-info-label">Version:</span>
                            <span class="resource-info-value" style="font-family: 'Monaco', 'Menlo', monospace; font-size: var(--font-size-xs);">main</span>
                        </div>
                        
                        <div class="resource-config-trigger" onclick="expandNode('app-node')">
                            <span>⚙️ Configure</span>
                            <span>→</span>
                        </div>

                        <div class="resource-config-content">
                            <div>
                            <div class="config-field">
                                <label>Repository</label>
                                <select id="app-repository">
                                    <option value="github.com/tavo/my-awesome-app">github.com/tavo/my-awesome-app</option>
                                    <option value="github.com/tavo/api-service">github.com/tavo/api-service</option>
                                    <option value="github.com/tavo/frontend-app">github.com/tavo/frontend-app</option>
                                    <option value="github.com/tavo/mobile-app">github.com/tavo/mobile-app</option>
                                    <option value="github.com/tavo/data-pipeline">github.com/tavo/data-pipeline</option>
                                </select>
                                <small>Select the Git repository for this application</small>
                            </div>

                            <div class="config-field">
                                <label>CPU</label>
                                <input id="app-cpu" type="number" value="1" step="0.5" min="0.5" max="8">
                                <small>vCPU cores (0.5 - 8)</small>
                            </div>

                            <div class="config-field">
                                <label>Memory</label>
                                <input id="app-memory" type="text" value="512M">
                                <small>e.g., 512M, 1G, 2G</small>
                            </div>

                            <div class="config-field">
                                <label>Environment Variables</label>
                                <textarea id="app-env-vars" 
                                    style="font-family: 'Monaco', 'Menlo', monospace; min-height: 100px; background: var(--gray-900); color: var(--gray-200);"
                                    placeholder="KEY=value">DB_CONNECTION_STRING=postgres://...</textarea>
                                <small>One variable per line (KEY=value)</small>
                            </div>

                            <button class="config-close-btn" onclick="closeExpandedNode()">
                                ✓ Collapse Configuration
                            </button>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="add-resource-btn" class="btn btn-secondary btn-icon" style="align-self: flex-start; position: relative;" onclick="showResourceModal()">
                    + Add Resource
                </button>
            </div>

            <div class="code-editor-container">
                <div class="editor-tooltip" id="editorTooltip">
                    💡 Try editing the YAML! Changes sync automatically to the canvas
                </div>
                <div class="editor-header">
                    <div class="editor-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span>unhazzle.yaml</span>
                    <span style="margin-left: auto; opacity: 0.6;">
                        <span style="display: inline-block; width: 6px; height: 6px; background: var(--success-color); border-radius: 50%; margin-right: 6px;"></span>
                        <span id="sync-status">Auto-sync enabled</span>
                    </span>
                </div>
                <textarea id="yaml-input" spellcheck="false" style="
                    flex: 1;
                    width: 100%;
                    min-height: 0;
                    padding: var(--space-4);
                    margin: 0;
                    border: none;
                    background: var(--gray-900);
                    color: var(--gray-200);
                    font-family: 'Monaco', 'Menlo', monospace;
                    font-size: var(--font-size-sm);
                    line-height: 1.5;
                    resize: none;
                    outline: none;
                ">version: '1.0'
project: silent-wind-1234
environment: dev

resources:
  - name: my-awesome-app
    type: application
    source:
      repo: github.com/tavo/my-awesome-app
      dockerfile: ./Dockerfile
    resources:
      cpu: 1
      memory: 512M
    env:
      - name: DB_CONNECTION_STRING
        value: postgres://...

  - name: my-app-db
    type: database
    engine: postgres
    version: '14'
    size: 1G</textarea>
            </div>
        </div>

        <div class="actions-bar">
            <div class="actions-left">
                <span style="color: var(--text-tertiary); font-size: var(--font-size-sm);">
                    ⚠️ Resources not yet deployed
                </span>
            </div>
            <div class="actions-right">
                <button class="btn btn-secondary" onclick="location.href='06-export.html'">
                    Export YAML
                </button>
                <button class="btn btn-primary" id="apply-button" onclick="location.href='05-apply.html'">
                    Apply Changes
                </button>
            </div>
        </div>
    </main>

    <!-- Resource Selection Modal -->
    <div id="resourceModal" class="resource-modal">
        <div class="resource-modal-content">
            <div class="resource-modal-header">
                <button class="modal-close" onclick="hideResourceModal()" aria-label="Close modal">×</button>
                <h2>Add a Resource</h2>
                <p>Choose the type of infrastructure resource you want to create</p>
            </div>
            <div class="resource-modal-body">
                <div class="resource-grid">
                    <div class="resource-option" onclick="selectResource('application')">
                        <div class="resource-option-icon">🚀</div>
                        <h3>Application</h3>
                        <p>Deploy containerized applications with automatic CI/CD from your Git repository.</p>
                    </div>

                    <div class="resource-option" onclick="selectResource('database')">
                        <div class="resource-option-icon">🗄️</div>
                        <h3>Database</h3>
                        <p>Provision a managed database with PostgreSQL, MySQL, or MongoDB.</p>
                    </div>

                    <div class="resource-option" onclick="selectResource('function')">
                        <div class="resource-option-icon">⚡</div>
                        <h3>Function / Task</h3>
                        <p>Run serverless functions or background tasks on-demand without managing servers.</p>
                    </div>

                    <div class="resource-option" onclick="selectResource('cache')">
                        <div class="resource-option-icon">💨</div>
                        <h3>Cache</h3>
                        <p>Set up a Redis or Valkey cache to boost your application performance.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showResourceModal() {
            const modal = document.getElementById('resourceModal');
            
            // Remove all existing highlights and tooltips first
            const allOptions = modal.querySelectorAll('.resource-option');
            allOptions.forEach(option => {
                option.classList.remove('highlighted');
                const existingTooltip = option.querySelector('.tour-tooltip');
                if (existingTooltip) {
                    existingTooltip.remove();
                }
            });
            
            // Add appropriate tooltip and highlight based on current state
            if (!config.database) {
                // If no database yet, guide to database
                const dbOption = modal.querySelector('.resource-option[onclick*="database"]');
                if (dbOption) {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tour-tooltip';
                    tooltip.textContent = '👆 Next, add a database for your app';
                    dbOption.insertBefore(tooltip, dbOption.firstChild);
                    dbOption.classList.add('highlighted');
                }
            } else if (!config.cache) {
                // If database exists but no cache, guide to cache
                const cacheOption = modal.querySelector('.resource-option[onclick*="cache"]');
                if (cacheOption) {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tour-tooltip';
                    tooltip.textContent = '👆 Finally, add a cache to boost performance';
                    cacheOption.insertBefore(tooltip, cacheOption.firstChild);
                    cacheOption.classList.add('highlighted');
                }
            }
            
            modal.classList.add('active');
        }

        function hideResourceModal() {
            document.getElementById('resourceModal').classList.remove('active');
        }

        function selectResource(type) {
            if (type === 'database' && !config.database) {
                hideResourceModal();
                addDatabaseResource();
            } else if (type === 'cache' && !config.cache) {
                hideResourceModal();
                addCacheResource();
            } else {
                // For demo, just close modal if trying to add existing or unsupported resource
                hideResourceModal();
            }
        }

        // Close modal when clicking outside
        document.getElementById('resourceModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideResourceModal();
            }
        });



        // Configuration state
        const config = {
            application: {
                name: 'my-awesome-app',
                type: 'application',
                repo: 'github.com/tavo/my-awesome-app',
                dockerfile: './Dockerfile',
                cpu: 1,
                memory: '512M',
                envVars: 'DB_CONNECTION_STRING=postgres://...'
            },
            database: null, // Will be populated when user adds database resource
            cache: null // Will be populated when user adds cache resource
        };

        // Check if we should load all resources (coming from dashboard)
        const loadAllResources = sessionStorage.getItem('loadAllResources');
        if (loadAllResources === 'true') {
            // Initialize with all resources
            config.database = {
                name: 'my-app-db',
                type: 'database',
                engine: 'postgres',
                version: '14',
                storage: '1G',
                backups: true,
                retention: 7
            };
            config.cache = {
                name: 'my-cache',
                type: 'cache',
                engine: 'redis',
                version: '7',
                memory: '256M'
            };
            // Clear the flag
            sessionStorage.removeItem('loadAllResources');
        }

        // Generate YAML from config
        function generateYAML() {
            let resources = [];

            // Add application resource if it exists
            if (config.application) {
                const envVarsArray = config.application.envVars
                    .split('\n')
                    .filter(line => line.trim())
                    .map(line => {
                        const [key, ...valueParts] = line.split('=');
                        const value = valueParts.join('=');
                        return `      - <span class="yaml-key">name:</span> <span class="yaml-value">${key.trim()}</span>
        <span class="yaml-key">value:</span> <span class="yaml-value">${value.trim()}</span>`;
                    })
                    .join('\n');

                resources.push(`  - <span class="yaml-key">name:</span> <span class="yaml-value">${config.application.name}</span>
    <span class="yaml-key">type:</span> <span class="yaml-value">${config.application.type}</span>
    <span class="yaml-key">source:</span>
      <span class="yaml-key">repo:</span> <span class="yaml-value">${config.application.repo}</span>
      <span class="yaml-key">dockerfile:</span> <span class="yaml-value">${config.application.dockerfile}</span>
    <span class="yaml-key">resources:</span>
      <span class="yaml-key">cpu:</span> <span class="yaml-value">${config.application.cpu}</span>
      <span class="yaml-key">memory:</span> <span class="yaml-value">${config.application.memory}</span>
    <span class="yaml-key">env:</span>
${envVarsArray}`);
            }

            // Add database resource if it exists
            if (config.database) {
                resources.push(`  - <span class="yaml-key">name:</span> <span class="yaml-value">${config.database.name}</span>
    <span class="yaml-key">type:</span> <span class="yaml-value">${config.database.type}</span>
    <span class="yaml-key">engine:</span> <span class="yaml-value">${config.database.engine}</span>
    <span class="yaml-key">version:</span> <span class="yaml-value">'${config.database.version}'</span>
    <span class="yaml-key">size:</span> <span class="yaml-value">${config.database.storage}</span>
    <span class="yaml-key">backups:</span> <span class="yaml-value">${config.database.backups}</span>
    <span class="yaml-key">retention:</span> <span class="yaml-value">${config.database.retention}d</span>`);
            }

            // Add cache resource if it exists
            if (config.cache) {
                resources.push(`  - <span class="yaml-key">name:</span> <span class="yaml-value">${config.cache.name}</span>
    <span class="yaml-key">type:</span> <span class="yaml-value">${config.cache.type}</span>
    <span class="yaml-key">engine:</span> <span class="yaml-value">${config.cache.engine}</span>
    <span class="yaml-key">version:</span> <span class="yaml-value">'${config.cache.version}'</span>
    <span class="yaml-key">memory:</span> <span class="yaml-value">${config.cache.memory}</span>`);
            }

            const resourcesYAML = resources.length > 0 ? resources.join('\n\n') : '  <span class="yaml-comment"># No resources configured</span>';

            return `<span class="yaml-key">version:</span> <span class="yaml-value">'1.0'</span>
<span class="yaml-key">project:</span> <span class="yaml-value">silent-wind-1234</span>
<span class="yaml-key">environment:</span> <span class="yaml-value">dev</span>

<span class="yaml-key">resources:</span>
${resourcesYAML}`;
        }

        // Update YAML editor
        function updateYAMLEditor(skipTextarea = false) {
            const textarea = document.getElementById('yaml-input');
            
            // Update textarea with plain YAML if not triggered by textarea change
            if (!skipTextarea && textarea) {
                textarea.value = generatePlainYAML();
            }
            
            // Save config to sessionStorage for export page
            sessionStorage.setItem('unhazzleConfig', JSON.stringify(config));
        }

        // Generate plain YAML (without HTML tags)
        function generatePlainYAML() {
            let resources = [];

            if (config.application) {
                const envVarsArray = config.application.envVars
                    .split('\n')
                    .filter(line => line.trim())
                    .map(line => {
                        const [key, ...valueParts] = line.split('=');
                        const value = valueParts.join('=');
                        return `      - name: ${key.trim()}
        value: ${value.trim()}`;
                    })
                    .join('\n');

                resources.push(`  - name: ${config.application.name}
    type: ${config.application.type}
    source:
      repo: ${config.application.repo}
      dockerfile: ${config.application.dockerfile}
    resources:
      cpu: ${config.application.cpu}
      memory: ${config.application.memory}
    env:
${envVarsArray}`);
            }

            if (config.database) {
                resources.push(`  - name: ${config.database.name}
    type: ${config.database.type}
    engine: ${config.database.engine}
    version: '${config.database.version}'
    size: ${config.database.storage}
    backups: ${config.database.backups}
    retention: ${config.database.retention}d`);
            }

            if (config.cache) {
                resources.push(`  - name: ${config.cache.name}
    type: ${config.cache.type}
    engine: ${config.cache.engine}
    version: '${config.cache.version}'
    memory: ${config.cache.memory}`);
            }

            const resourcesYAML = resources.length > 0 ? resources.join('\n\n') : '  # No resources configured';

            return `version: '1.0'
project: silent-wind-1234
environment: dev

resources:
${resourcesYAML}`;
        }

        // Parse YAML and update config
        function parseYAMLAndUpdateCanvas(yamlText) {
            try {
                // Simple YAML parser for our specific structure
                const lines = yamlText.split('\n');
                let currentResource = null;
                let currentSection = null;
                let envVars = [];
                const parsedResources = [];

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const trimmed = line.trim();

                    // Skip empty lines and version/project/environment
                    if (!trimmed || trimmed.startsWith('version:') || trimmed.startsWith('project:') || 
                        trimmed.startsWith('environment:') || trimmed.startsWith('resources:') || 
                        trimmed.startsWith('#')) {
                        continue;
                    }

                    // New resource
                    if (trimmed.startsWith('- name:') || (line.startsWith('  - ') && trimmed.includes('name:'))) {
                        if (currentResource) {
                            if (currentResource.type === 'application' && envVars.length > 0) {
                                currentResource.envVars = envVars.map(ev => `${ev.name}=${ev.value}`).join('\n');
                            }
                            parsedResources.push(currentResource);
                        }
                        currentResource = {};
                        envVars = [];
                        currentSection = null;
                        const nameMatch = trimmed.match(/name:\s*(.+)/);
                        if (nameMatch) currentResource.name = nameMatch[1].replace(/['"]/g, '');
                    }
                    // Resource properties
                    else if (currentResource) {
                        if (trimmed.startsWith('type:')) {
                            currentResource.type = trimmed.split(':')[1].trim().replace(/['"]/g, '');
                        }
                        else if (trimmed.startsWith('engine:')) {
                            currentResource.engine = trimmed.split(':')[1].trim().replace(/['"]/g, '');
                        }
                        else if (trimmed.startsWith('version:')) {
                            currentResource.version = trimmed.split(':')[1].trim().replace(/['"]/g, '');
                        }
                        else if (trimmed.startsWith('repo:')) {
                            currentResource.repo = trimmed.split(':')[1].trim().replace(/['"]/g, '');
                        }
                        else if (trimmed.startsWith('dockerfile:')) {
                            currentResource.dockerfile = trimmed.split(':')[1].trim().replace(/['"]/g, '');
                        }
                        else if (trimmed.startsWith('cpu:')) {
                            currentResource.cpu = parseFloat(trimmed.split(':')[1].trim());
                        }
                        else if (trimmed.startsWith('memory:')) {
                            currentResource.memory = trimmed.split(':')[1].trim().replace(/['"]/g, '');
                        }
                        else if (trimmed.startsWith('size:')) {
                            currentResource.storage = trimmed.split(':')[1].trim().replace(/['"]/g, '');
                        }
                        else if (trimmed.startsWith('backups:')) {
                            currentResource.backups = trimmed.split(':')[1].trim() === 'true';
                        }
                        else if (trimmed.startsWith('retention:')) {
                            const retMatch = trimmed.match(/(\d+)/);
                            if (retMatch) currentResource.retention = parseInt(retMatch[1]);
                        }
                        // Handle env section
                        else if (trimmed.startsWith('env:')) {
                            currentSection = 'env';
                        }
                        else if (currentSection === 'env' && trimmed.startsWith('- name:')) {
                            const envName = trimmed.split(':')[1].trim().replace(/['"]/g, '');
                            // Look ahead for value
                            if (i + 1 < lines.length) {
                                const nextLine = lines[i + 1].trim();
                                if (nextLine.startsWith('value:')) {
                                    const envValue = nextLine.split(':')[1].trim().replace(/['"]/g, '');
                                    envVars.push({ name: envName, value: envValue });
                                }
                            }
                        }
                    }
                }

                // Add last resource
                if (currentResource) {
                    if (currentResource.type === 'application' && envVars.length > 0) {
                        currentResource.envVars = envVars.map(ev => `${ev.name}=${ev.value}`).join('\n');
                    }
                    parsedResources.push(currentResource);
                }

                // Update config and canvas
                updateConfigFromParsedYAML(parsedResources);
                
            } catch (error) {
                console.error('YAML parsing error:', error);
                document.getElementById('sync-status').textContent = 'Parse error';
                setTimeout(() => {
                    document.getElementById('sync-status').textContent = 'Auto-sync enabled';
                }, 2000);
            }
        }

        // Update config and rebuild canvas from parsed YAML
        function updateConfigFromParsedYAML(parsedResources) {
            // Update config based on parsed resources
            config.application = null;
            config.database = null;
            config.cache = null;

            parsedResources.forEach(resource => {
                if (resource.type === 'application') {
                    config.application = {
                        name: resource.name || 'my-awesome-app',
                        type: 'application',
                        repo: resource.repo || 'github.com/tavo/my-awesome-app',
                        dockerfile: resource.dockerfile || './Dockerfile',
                        cpu: resource.cpu || 1,
                        memory: resource.memory || '512M',
                        envVars: resource.envVars || ''
                    };
                } else if (resource.type === 'database') {
                    config.database = {
                        name: resource.name || 'my-app-db',
                        type: 'database',
                        engine: resource.engine || 'postgres',
                        version: resource.version || '14',
                        storage: resource.storage || '1G',
                        backups: resource.backups !== undefined ? resource.backups : true,
                        retention: resource.retention || 7
                    };
                } else if (resource.type === 'cache') {
                    config.cache = {
                        name: resource.name || 'my-cache',
                        type: 'cache',
                        engine: resource.engine || 'redis',
                        version: resource.version || '7',
                        memory: resource.memory || '256M'
                    };
                }
            });

            // Rebuild canvas to reflect changes
            rebuildCanvas();
        }

        // Rebuild canvas from config
        function rebuildCanvas() {
            // This will be called after parsing YAML
            // For now, we'll just update the form inputs
            updateCanvasFromConfig();
            updateYAMLEditor(true); // Skip textarea update to avoid loop
        }

        // Update canvas inputs from config
        function updateCanvasFromConfig() {
            if (config.application) {
                // Update form inputs
                const repoInput = document.getElementById('app-repository');
                const cpuInput = document.getElementById('app-cpu');
                const memoryInput = document.getElementById('app-memory');
                const envVarsInput = document.getElementById('app-env-vars');

                if (repoInput) repoInput.value = config.application.repo;
                if (cpuInput) cpuInput.value = config.application.cpu;
                if (memoryInput) memoryInput.value = config.application.memory;
                if (envVarsInput) envVarsInput.value = config.application.envVars;
                
                // Update displayed values
                const appNameTitle = document.getElementById('app-name-title');
                if (appNameTitle) appNameTitle.textContent = config.application.name;
                
                const appNode = document.getElementById('app-node');
                if (appNode) {
                    const infoItems = appNode.querySelectorAll('.resource-info-item');
                    if (infoItems.length >= 1) {
                        const repoValueSpan = infoItems[0].querySelector('.resource-info-value');
                        if (repoValueSpan) repoValueSpan.textContent = config.application.repo;
                    }
                }
            }

            if (config.database) {
                // Update form inputs
                const engineSelect = document.getElementById('db-engine');
                const storageInput = document.getElementById('db-storage');
                const backupsCheckbox = document.getElementById('db-backups');
                const retentionSelect = document.getElementById('db-retention');

                if (engineSelect) engineSelect.value = `${config.database.engine}:${config.database.version}`;
                if (storageInput) storageInput.value = config.database.storage;
                if (backupsCheckbox) backupsCheckbox.checked = config.database.backups;
                if (retentionSelect) retentionSelect.value = config.database.retention;
                
                // Update displayed values
                const dbNameTitle = document.getElementById('db-name-title');
                if (dbNameTitle) dbNameTitle.textContent = config.database.name;
                
                const dbNode = document.getElementById('db-node');
                if (dbNode) {
                    const infoItems = dbNode.querySelectorAll('.resource-info-item');
                    if (infoItems.length >= 1) {
                        const engineValueSpan = infoItems[0].querySelector('.resource-info-value');
                        if (engineValueSpan) {
                            const engineNames = {
                                'postgres': 'PostgreSQL',
                                'mysql': 'MySQL',
                                'mariadb': 'MariaDB',
                                'redis': 'Redis',
                                'mongodb': 'MongoDB'
                            };
                            engineValueSpan.textContent = `${engineNames[config.database.engine] || config.database.engine} ${config.database.version}`;
                        }
                    }
                    if (infoItems.length >= 2) {
                        const storageValueSpan = infoItems[1].querySelector('.resource-info-value');
                        if (storageValueSpan) storageValueSpan.textContent = config.database.storage;
                    }
                }
            }

            if (config.cache) {
                // Update form inputs
                const cacheEngineSelect = document.getElementById('cache-engine');
                const cacheMemoryInput = document.getElementById('cache-memory');

                if (cacheEngineSelect) cacheEngineSelect.value = `${config.cache.engine}:${config.cache.version}`;
                if (cacheMemoryInput) cacheMemoryInput.value = config.cache.memory;
                
                // Update displayed values
                const cacheNameTitle = document.getElementById('cache-name-title');
                if (cacheNameTitle) cacheNameTitle.textContent = config.cache.name;
                
                const cacheNode = document.getElementById('cache-node');
                if (cacheNode) {
                    const infoItems = cacheNode.querySelectorAll('.resource-info-item');
                    if (infoItems.length >= 1) {
                        const engineValueSpan = infoItems[0].querySelector('.resource-info-value');
                        if (engineValueSpan) {
                            const engineNames = {
                                'redis': 'Redis OSS',
                                'valkey': 'Valkey'
                            };
                            engineValueSpan.textContent = `${engineNames[config.cache.engine] || config.cache.engine} ${config.cache.version}`;
                        }
                    }
                    if (infoItems.length >= 2) {
                        const memoryValueSpan = infoItems[1].querySelector('.resource-info-value');
                        if (memoryValueSpan) memoryValueSpan.textContent = config.cache.memory;
                    }
                }
            }
        }

        // Application configuration listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Repository select
            const repositorySelect = document.getElementById('app-repository');
            if (repositorySelect) {
                repositorySelect.addEventListener('change', function(e) {
                    config.application.repo = e.target.value;
                    // Update displayed repository value
                    const appNode = document.getElementById('app-node');
                    const repoValueSpan = appNode?.querySelector('.resource-info-item .resource-info-value');
                    if (repoValueSpan) {
                        repoValueSpan.textContent = e.target.value;
                    }
                    updateYAMLEditor();
                });
            }

            // CPU input
            const cpuInput = document.getElementById('app-cpu');
            if (cpuInput) {
                cpuInput.addEventListener('input', function(e) {
                    config.application.cpu = parseFloat(e.target.value);
                    updateYAMLEditor();
                });
            }

            // Memory input
            const memoryInput = document.getElementById('app-memory');
            if (memoryInput) {
                memoryInput.addEventListener('input', function(e) {
                    config.application.memory = e.target.value;
                    updateYAMLEditor();
                });
            }

            // Environment variables
            const envVarsInput = document.getElementById('app-env-vars');
            if (envVarsInput) {
                envVarsInput.addEventListener('input', function(e) {
                    config.application.envVars = e.target.value;
                    updateYAMLEditor();
                });
            }



            // YAML textarea input listener
            const yamlInput = document.getElementById('yaml-input');
            if (yamlInput) {
                let debounceTimer;
                yamlInput.addEventListener('input', function(e) {
                    // Clear previous timer
                    clearTimeout(debounceTimer);
                    
                    // Debounce parsing (wait 500ms after user stops typing)
                    debounceTimer = setTimeout(() => {
                        parseYAMLAndUpdateCanvas(e.target.value);
                    }, 500);
                });
            }

            // Resource name title listeners
            setupResourceNameListeners();

            // Initial YAML generation
            updateYAMLEditor();

            // If all resources should be loaded, add them to the canvas
            if (config.database && !document.getElementById('db-node')) {
                addDatabaseResource();
            }
            if (config.cache && !document.getElementById('cache-node')) {
                addCacheResource();
            }
        });

        // Setup listeners for editable resource names
        function setupResourceNameListeners() {
            const appTitle = document.getElementById('app-name-title');
            const dbTitle = document.getElementById('db-name-title');
            const cacheTitle = document.getElementById('cache-name-title');

            if (appTitle) {
                addNameEditListener(appTitle, 'application');
            }
            if (dbTitle) {
                addNameEditListener(dbTitle, 'database');
            }
            if (cacheTitle) {
                addNameEditListener(cacheTitle, 'cache');
            }
        }

        // Add edit listener to a resource name title
        function addNameEditListener(element, resourceType) {
            // Handle input changes
            element.addEventListener('input', function(e) {
                const fullText = e.target.textContent.trim();
                // Extract name (remove emoji)
                const name = fullText.replace(/^[^\w\s]+\s*/, '').trim();
                
                if (resourceType === 'application' && config.application) {
                    config.application.name = name;
                } else if (resourceType === 'database' && config.database) {
                    config.database.name = name;
                } else if (resourceType === 'cache' && config.cache) {
                    config.cache.name = name;
                }
                
                updateYAMLEditor();
            });

            // Prevent line breaks
            element.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    element.blur();
                }
            });

            // Select text on focus for easy editing
            element.addEventListener('focus', function() {
                // Select only the text part (after emoji)
                const range = document.createRange();
                const sel = window.getSelection();
                const textNode = this.childNodes[0];
                
                if (textNode) {
                    const text = textNode.textContent;
                    const match = text.match(/^[^\w\s]+\s*/);
                    const offset = match ? match[0].length : 0;
                    
                    try {
                        range.setStart(textNode, offset);
                        range.setEnd(textNode, text.length);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    } catch (e) {
                        // If selection fails, select all
                        const range = document.createRange();
                        range.selectNodeContents(this);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }
            });
        }

        // Functions for expanding/collapsing nodes
        function expandNode(nodeId) {
            // First, collapse any other expanded nodes
            const allNodes = document.querySelectorAll('.resource-node');
            allNodes.forEach(node => {
                if (node.id !== nodeId) {
                    node.classList.remove('expanded');
                }
            });
            
            // Then expand the clicked node
            const node = document.getElementById(nodeId);
            if (node) {
                node.classList.add('expanded');
                // Smooth scroll to the node
                setTimeout(() => {
                    node.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            }
        }

        function closeExpandedNode() {
            const expandedNode = document.querySelector('.resource-node.expanded');
            if (expandedNode) {
                expandedNode.classList.remove('expanded');
            }
        }

        // Close with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeExpandedNode();
                hideResourceModal();
            }
        });

        // Function to add database resource to the canvas
        function addDatabaseResource() {
            // Remove tooltip from Add Resource button
            const existingTooltip = document.getElementById('add-resource-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }

            // Initialize database config
            config.database = {
                name: 'my-app-db',
                type: 'database',
                engine: 'postgres',
                version: '14',
                storage: '1G',
                backups: true,
                retention: 7
            };

            // Create the database resource node HTML
            const dbNode = document.createElement('div');
            dbNode.className = 'resource-node';
            dbNode.id = 'db-node';
            dbNode.innerHTML = `
                <button class="resource-remove-btn" onclick="removeResource('database')" title="Remove resource">×</button>
                <div class="resource-node-header">
                    <div class="resource-node-title" contenteditable="true" id="db-name-title" data-resource-type="database">my-app-db</div>
                    <div class="resource-badge">DB</div>
                </div>
                <div class="resource-node-content">
                    <div class="resource-info-item">
                        <span class="resource-info-label">Engine:</span>
                        <span class="resource-info-value">PostgreSQL 14</span>
                    </div>
                    <div class="resource-info-item">
                        <span class="resource-info-label">Storage:</span>
                        <span class="resource-info-value">1G</span>
                    </div>
                    
                    <div class="resource-config-trigger" onclick="expandNode('db-node')">
                        <span>⚙️ Configure</span>
                        <span>→</span>
                    </div>

                    <div class="resource-config-content">
                        <div>
                        <div class="config-field">
                            <label>Engine</label>
                            <select id="db-engine">
                                <option value="postgres:14" selected>PostgreSQL 14</option>
                                <option value="postgres:15">PostgreSQL 15</option>
                                <option value="postgres:16">PostgreSQL 16</option>
                                <option value="mysql:8.0">MySQL 8.0</option>
                                <option value="mysql:8.4">MySQL 8.4</option>
                                <option value="mariadb:10.11">MariaDB 10.11</option>
                                <option value="mariadb:11.4">MariaDB 11.4</option>
                                <option value="redis:7">Redis 7</option>
                                <option value="mongodb:7.0">MongoDB 7.0</option>
                            </select>
                            <small>Select the database engine and version</small>
                        </div>

                        <div class="config-field">
                            <label>Storage</label>
                            <input id="db-storage" type="text" value="1G">
                            <small>e.g., 1G, 10G, 100G</small>
                        </div>

                        <div class="config-field">
                            <label class="config-field-checkbox">
                                <input id="db-backups" type="checkbox" checked>
                                <span>Enable daily automatic backups</span>
                            </label>
                        </div>

                        <div class="config-field">
                            <label>Backup Retention</label>
                            <select id="db-retention">
                                <option value="3">3 days</option>
                                <option value="7" selected>7 days</option>
                                <option value="14">14 days</option>
                                <option value="30">30 days</option>
                            </select>
                            <small>How long to keep backup snapshots</small>
                        </div>

                        <button class="config-close-btn" onclick="closeExpandedNode()">
                            ✓ Collapse Configuration
                        </button>
                        </div>
                    </div>
                </div>
            `;

            // Insert the database node before the Add Resource button
            const canvas = document.querySelector('.canvas-workspace');
            const addBtn = document.getElementById('add-resource-btn');
            canvas.insertBefore(dbNode, addBtn);

            // Add event listeners for database configuration
            const engineSelect = document.getElementById('db-engine');
            if (engineSelect) {
                engineSelect.addEventListener('change', function(e) {
                    const [engine, version] = e.target.value.split(':');
                    config.database.engine = engine;
                    config.database.version = version;
                    
                    // Update displayed engine value
                    const dbNode = document.getElementById('db-node');
                    const engineValueSpan = dbNode?.querySelector('.resource-info-item .resource-info-value');
                    if (engineValueSpan) {
                        const engineNames = {
                            'postgres': 'PostgreSQL',
                            'mysql': 'MySQL',
                            'mariadb': 'MariaDB',
                            'redis': 'Redis',
                            'mongodb': 'MongoDB'
                        };
                        engineValueSpan.textContent = `${engineNames[engine] || engine} ${version}`;
                    }
                    updateYAMLEditor();
                });
            }

            const storageInput = document.getElementById('db-storage');
            if (storageInput) {
                storageInput.addEventListener('input', function(e) {
                    config.database.storage = e.target.value;
                    
                    // Update displayed storage value
                    const dbNode = document.getElementById('db-node');
                    const infoItems = dbNode?.querySelectorAll('.resource-info-item');
                    if (infoItems && infoItems.length > 1) {
                        const storageValueSpan = infoItems[1].querySelector('.resource-info-value');
                        if (storageValueSpan) {
                            storageValueSpan.textContent = e.target.value;
                        }
                    }
                    updateYAMLEditor();
                });
            }

            const backupsCheckbox = document.getElementById('db-backups');
            if (backupsCheckbox) {
                backupsCheckbox.addEventListener('change', function(e) {
                    config.database.backups = e.target.checked;
                    updateYAMLEditor();
                });
            }

            const retentionSelect = document.getElementById('db-retention');
            if (retentionSelect) {
                retentionSelect.addEventListener('change', function(e) {
                    config.database.retention = parseInt(e.target.value);
                    updateYAMLEditor();
                });
            }

            // Add name edit listener for database title
            const dbTitle = document.getElementById('db-name-title');
            if (dbTitle) {
                addNameEditListener(dbTitle, 'database');
            }

            // Update YAML to include the new database resource
            updateYAMLEditor();

            // Add tooltip to Add Resource button for cache
            const addResourceBtn = document.getElementById('add-resource-btn');
            if (addResourceBtn && !document.getElementById('add-resource-tooltip')) {
                const tooltip = document.createElement('div');
                tooltip.id = 'add-resource-tooltip';
                tooltip.className = 'add-resource-tooltip';
                tooltip.textContent = '👆 Add a cache to boost performance';
                addResourceBtn.appendChild(tooltip);
            }
        }

        // Function to add cache resource to the canvas
        function addCacheResource() {
            // Remove tooltip from Add Resource button
            const existingTooltip = document.getElementById('add-resource-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }

            // Initialize cache config
            config.cache = {
                name: 'my-cache',
                type: 'cache',
                engine: 'redis',
                version: '7',
                memory: '256M'
            };

            // Create the cache resource node HTML
            const cacheNode = document.createElement('div');
            cacheNode.className = 'resource-node';
            cacheNode.id = 'cache-node';
            cacheNode.innerHTML = `
                <button class="resource-remove-btn" onclick="removeResource('cache')" title="Remove resource">×</button>
                <div class="resource-node-header">
                    <div class="resource-node-title" contenteditable="true" id="cache-name-title" data-resource-type="cache">my-cache</div>
                    <div class="resource-badge">Cache</div>
                </div>
                <div class="resource-node-content">
                    <div class="resource-info-item">
                        <span class="resource-info-label">Engine:</span>
                        <span class="resource-info-value">Redis OSS 7</span>
                    </div>
                    <div class="resource-info-item">
                        <span class="resource-info-label">Memory:</span>
                        <span class="resource-info-value">256M</span>
                    </div>
                    
                    <div class="resource-config-trigger" onclick="expandNode('cache-node')">
                        <span>⚙️ Configure</span>
                        <span>→</span>
                    </div>

                    <div class="resource-config-content">
                        <div>
                        <div class="config-field">
                            <label>Engine</label>
                            <select id="cache-engine">
                                <option value="redis:7" selected>Redis OSS 7</option>
                                <option value="valkey:7.2">Valkey 7.2</option>
                                <option value="memcached:1.6">Memcached 1.6</option>
                            </select>
                            <small>Select the cache engine and version</small>
                        </div>

                        <div class="config-field">
                            <label>Memory</label>
                            <input id="cache-memory" type="text" value="256M">
                            <small>e.g., 256M, 512M, 1G</small>
                        </div>

                        <button class="config-close-btn" onclick="closeExpandedNode()">
                            ✓ Collapse Configuration
                        </button>
                        </div>
                    </div>
                </div>
            `;

            // Insert the cache node before the Add Resource button
            const canvas = document.querySelector('.canvas-workspace');
            const addBtn = document.getElementById('add-resource-btn');
            canvas.insertBefore(cacheNode, addBtn);

            // Hide the Add Resource button after adding cache
            addBtn.style.display = 'none';

            // Add event listeners for cache configuration
            const cacheEngineSelect = document.getElementById('cache-engine');
            if (cacheEngineSelect) {
                cacheEngineSelect.addEventListener('change', function(e) {
                    const [engine, version] = e.target.value.split(':');
                    config.cache.engine = engine;
                    config.cache.version = version;
                    
                    // Update displayed engine value
                    const cacheNode = document.getElementById('cache-node');
                    const engineValueSpan = cacheNode?.querySelector('.resource-info-item .resource-info-value');
                    if (engineValueSpan) {
                        const engineNames = {
                            'redis': 'Redis OSS',
                            'valkey': 'Valkey'
                        };
                        engineValueSpan.textContent = `${engineNames[engine] || engine} ${version}`;
                    }
                    updateYAMLEditor();
                });
            }

            const cacheMemoryInput = document.getElementById('cache-memory');
            if (cacheMemoryInput) {
                cacheMemoryInput.addEventListener('input', function(e) {
                    config.cache.memory = e.target.value;
                    
                    // Update displayed memory value
                    const cacheNode = document.getElementById('cache-node');
                    const infoItems = cacheNode?.querySelectorAll('.resource-info-item');
                    if (infoItems && infoItems.length > 1) {
                        const memoryValueSpan = infoItems[1].querySelector('.resource-info-value');
                        if (memoryValueSpan) {
                            memoryValueSpan.textContent = e.target.value;
                        }
                    }
                    updateYAMLEditor();
                });
            }

            // Add name edit listener for cache title
            const cacheTitle = document.getElementById('cache-name-title');
            if (cacheTitle) {
                addNameEditListener(cacheTitle, 'cache');
            }

            // Update YAML to include the new cache resource
            updateYAMLEditor();

            // Add tooltip to Apply Changes button
            const applyButton = document.getElementById('apply-button');
            if (applyButton && !document.getElementById('apply-tooltip')) {
                const tooltip = document.createElement('div');
                tooltip.id = 'apply-tooltip';
                tooltip.className = 'apply-button-tooltip';
                tooltip.textContent = '👆 Ready? Click here to deploy your infrastructure';
                applyButton.appendChild(tooltip);
            }
        }

        // Function to remove a resource from the canvas
        function removeResource(resourceType) {
            let nodeId, confirmMessage;
            
            switch(resourceType) {
                case 'application':
                    nodeId = 'app-node';
                    confirmMessage = 'Are you sure you want to remove the application resource? This cannot be undone.';
                    break;
                case 'database':
                    nodeId = 'db-node';
                    confirmMessage = 'Are you sure you want to remove the database resource? This cannot be undone.';
                    break;
                case 'cache':
                    nodeId = 'cache-node';
                    confirmMessage = 'Are you sure you want to remove the cache resource?';
                    break;
            }
            
            if (confirm(confirmMessage)) {
                // Remove the node from the DOM
                const node = document.getElementById(nodeId);
                if (node) {
                    node.remove();
                }
                
                // Update the config
                if (resourceType === 'application') {
                    config.application = null;
                } else if (resourceType === 'database') {
                    config.database = null;
                } else if (resourceType === 'cache') {
                    config.cache = null;
                    // Show the Add Resource button again
                    const addBtn = document.getElementById('add-resource-btn');
                    if (addBtn) {
                        addBtn.style.display = '';
                    }
                }
                
                // Update YAML editor
                updateYAMLEditor();
            }
        }

        // Add initial tooltip to Add Resource button
        function addInitialResourceTooltip() {
            const addResourceBtn = document.getElementById('add-resource-btn');
            if (addResourceBtn && !document.getElementById('add-resource-tooltip')) {
                const tooltip = document.createElement('div');
                tooltip.id = 'add-resource-tooltip';
                tooltip.className = 'add-resource-tooltip';
                tooltip.textContent = '👆 Add a database to store your data';
                addResourceBtn.appendChild(tooltip);
            }
        }

        // Call on page load
        addInitialResourceTooltip();

        // Load and display user name
        const userName = sessionStorage.getItem('userName') || 'Tavo';
        document.getElementById('userNameDisplay').textContent = userName;
        document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
        
        // Update repo URLs with username (lowercase)
        const githubUsername = userName.toLowerCase().replace(/\s+/g, '-');
        const repoURL = `github.com/${githubUsername}/my-awesome-app`;
        
        // Update all repository dropdown options with personalized username
        const appRepoSelect = document.getElementById('app-repository');
        if (appRepoSelect) {
            const repos = [
                'my-awesome-app',
                'api-service',
                'frontend-app',
                'mobile-app',
                'data-pipeline'
            ];
            
            // Clear existing options
            appRepoSelect.innerHTML = '';
            
            // Add personalized options
            repos.forEach(repo => {
                const option = document.createElement('option');
                option.value = `github.com/${githubUsername}/${repo}`;
                option.textContent = `github.com/${githubUsername}/${repo}`;
                if (repo === 'my-awesome-app') {
                    option.selected = true;
                }
                appRepoSelect.appendChild(option);
            });
        }
        
        // Update config if application exists
        if (config.application && config.application.repo === 'github.com/tavo/my-awesome-app') {
            config.application.repo = repoURL;
            updateYAMLEditor();
        }
    </script>
</body>
</html>
